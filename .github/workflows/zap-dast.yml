name: OWASP ZAP DAST Security Scan

on:
  push:
    branches:
      - master
      - main
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of ZAP scan to run'
        required: true
        default: 'baseline'
        type: choice
        options:
          - baseline
          - full
          - api

jobs:
  build-and-test:
    name: Build Application for DAST
    runs-on: ubuntu-latest
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build application
        run: mvn clean package -DskipTests

      - name: Build Docker image for DAST testing
        run: |
          docker build -t cicd-demo:latest .

      - name: Start application container
        run: |
          docker run -d --name cicd-demo-app -p 3000:3000 cicd-demo:latest
          
          # Wait for application to start
          echo "Waiting for application to start..."
          timeout=60
          while ! curl -f http://localhost:3000/ > /dev/null 2>&1; do
            sleep 2
            timeout=$((timeout - 2))
            if [ $timeout -le 0 ]; then
              echo "Application failed to start within 60 seconds"
              docker logs cicd-demo-app
              exit 1
            fi
          done
          echo "Application is running!"

      - name: Test application endpoints
        run: |
          echo "Testing application endpoints..."
          curl -f http://localhost:3000/ || exit 1
          curl -f http://localhost:3000/version || exit 1
          curl -f http://localhost:3000/nations || exit 1
          curl -f http://localhost:3000/currencies || exit 1
          echo "All endpoints are accessible!"

      - name: Save application logs
        if: always()
        run: |
          docker logs cicd-demo-app > app-logs.txt
          
      - name: Upload application logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: application-logs
          path: app-logs.txt

  zap-baseline-scan:
    name: ZAP Baseline Scan
    needs: build-and-test
    runs-on: ubuntu-latest
    if: inputs.scan_type == 'baseline' || inputs.scan_type == '' || github.event_name != 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and start application
        run: |
          mvn clean package -DskipTests
          docker build -t cicd-demo:latest .
          docker run -d --name cicd-demo-app -p 3000:3000 cicd-demo:latest
          
          # Wait for application to start
          timeout=60
          while ! curl -f http://localhost:3000/ > /dev/null 2>&1; do
            sleep 2
            timeout=$((timeout - 2))
            if [ $timeout -le 0 ]; then
              echo "Application failed to start"
              docker logs cicd-demo-app
              exit 1
            fi
          done

      - name: Run ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          
      - name: Upload ZAP Baseline Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: zap-baseline-report
          path: report_html.html

  zap-full-scan:
    name: ZAP Full Scan
    needs: build-and-test
    runs-on: ubuntu-latest
    if: inputs.scan_type == 'full'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and start application
        run: |
          mvn clean package -DskipTests
          docker build -t cicd-demo:latest .
          docker run -d --name cicd-demo-app -p 3000:3000 cicd-demo:latest
          
          # Wait for application to start
          timeout=60
          while ! curl -f http://localhost:3000/ > /dev/null 2>&1; do
            sleep 2
            timeout=$((timeout - 2))
            if [ $timeout -le 0 ]; then
              echo "Application failed to start"
              docker logs cicd-demo-app
              exit 1
            fi
          done

      - name: Run ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.8.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          
      - name: Upload ZAP Full Scan Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: zap-full-scan-report
          path: report_html.html

  zap-api-scan:
    name: ZAP API Scan
    needs: build-and-test
    runs-on: ubuntu-latest
    if: inputs.scan_type == 'api'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and start application
        run: |
          mvn clean package -DskipTests
          docker build -t cicd-demo:latest .
          docker run -d --name cicd-demo-app -p 3000:3000 cicd-demo:latest
          
          # Wait for application to start
          timeout=60
          while ! curl -f http://localhost:3000/ > /dev/null 2>&1; do
            sleep 2
            timeout=$((timeout - 2))
            if [ $timeout -le 0 ]; then
              echo "Application failed to start"
              docker logs cicd-demo-app
              exit 1
            fi
          done

      - name: Create API definition
        run: |
          mkdir -p .zap
          cat > .zap/api-definition.json << 'EOF'
          {
            "openapi": "3.0.0",
            "info": {
              "title": "CICD Demo API",
              "version": "1.0.0"
            },
            "servers": [
              {
                "url": "http://localhost:3000"
              }
            ],
            "paths": {
              "/": {
                "get": {
                  "summary": "Health check"
                }
              },
              "/version": {
                "get": {
                  "summary": "Get version"
                }
              },
              "/nations": {
                "get": {
                  "summary": "Get random nations"
                }
              },
              "/currencies": {
                "get": {
                  "summary": "Get random currencies"
                }
              },
              "/hash/{input}": {
                "get": {
                  "summary": "Create hash",
                  "parameters": [
                    {
                      "name": "input",
                      "in": "path",
                      "required": true,
                      "schema": {
                        "type": "string"
                      }
                    }
                  ]
                }
              },
              "/user": {
                "get": {
                  "summary": "Get user data",
                  "parameters": [
                    {
                      "name": "userId",
                      "in": "query",
                      "required": true,
                      "schema": {
                        "type": "string"
                      }
                    }
                  ]
                }
              }
            }
          }
          EOF

      - name: Run ZAP API Scan
        uses: zaproxy/action-api-scan@v0.6.0
        with:
          target: 'http://localhost:3000'
          format: 'openapi'
          api_spec: '.zap/api-definition.json'
          cmd_options: '-a'
          
      - name: Upload ZAP API Scan Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: zap-api-scan-report
          path: report_html.html

  security-summary:
    name: Security Scan Summary
    needs: [zap-baseline-scan, zap-full-scan, zap-api-scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate Security Summary
        run: |
          echo "## OWASP ZAP DAST Results" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status | Report |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.zap-baseline-scan.result }}" != "skipped" ]]; then
            echo "| Baseline | ${{ needs.zap-baseline-scan.result }} | [Download Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.zap-full-scan.result }}" != "skipped" ]]; then
            echo "| Full Scan | ${{ needs.zap-full-scan.result }} | [Download Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.zap-api-scan.result }}" != "skipped" ]]; then
            echo "| API Scan | ${{ needs.zap-api-scan.result }} | [Download Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” How to Review Results:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the HTML report from the artifacts section" >> $GITHUB_STEP_SUMMARY
          echo "2. Open the report in a web browser" >> $GITHUB_STEP_SUMMARY
          echo "3. Review High and Medium severity vulnerabilities first" >> $GITHUB_STEP_SUMMARY
          echo "4. Check the 'Alert Details' section for remediation guidance" >> $GITHUB_STEP_SUMMARY
