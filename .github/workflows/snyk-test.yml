name: Snyk Authentication Test

on:
  workflow_dispatch: # Manual trigger for testing
  push:
    branches: ["main", "master"]

jobs:
  snyk-test:
    name: Test Snyk Integration
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build project
        run: mvn clean compile

      - name: Check Snyk Token Configuration
        run: |
          echo "üîç Checking Snyk token configuration..."
          if [ -z "$SNYK_TOKEN" ]; then
            echo " SNYK_TOKEN is not configured in repository secrets"
            echo ""
            echo "To fix this:"
            echo "1. Go to https://app.snyk.io/account and create an account"
            echo "2. Navigate to Account Settings > API Token"
            echo "3. Copy your API token"
            echo "4. Go to https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "5. Click 'New repository secret'"
            echo "6. Name: SNYK_TOKEN"
            echo "7. Value: [paste your API token]"
            echo ""
            echo "  Will attempt to run without authentication (limited functionality)"
          else
            echo " SNYK_TOKEN is configured"
            echo "üîÑ Testing Snyk authentication..."
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Test Snyk using GitHub Action (Recommended)
        uses: snyk/actions/maven@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --sarif-file-output=snyk-action.sarif

      - name: Upload SARIF to GitHub Security
        if: always() && hashFiles('snyk-action.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-action.sarif
          category: snyk-action-test

      - name: Setup Instructions
        run: |
          echo "üöÄ Quick Setup Guide:"
          echo ""
          echo "1. Create Snyk Account:"
          echo "   - Visit: https://app.snyk.io/signup"
          echo "   - Sign up with GitHub or email"
          echo ""
          echo "2. Get API Token:"
          echo "   - Go to: https://app.snyk.io/account"
          echo "   - Click 'API Token' or 'Auth Token'"
          echo "   - Copy the token (starts with snyk-...)"
          echo ""
          echo "3. Add to GitHub Secrets:"
          echo "   - Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo "   - Click 'New repository secret'"
          echo "   - Name: SNYK_TOKEN"
          echo "   - Value: [your API token]"
          echo ""
          echo "4. Re-run this workflow to test the integration!"
          echo ""
          echo "üìù Note: The Snyk GitHub Action handles authentication automatically"
          echo "   when the SNYK_TOKEN secret is configured properly."

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-test-results
          path: |
            *.sarif
            *.json
            *.log
